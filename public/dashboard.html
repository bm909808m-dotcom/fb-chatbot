<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .chat-bubble { max-width: 75%; }
        /* কাস্টম স্ক্রলবার */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen overflow-hidden">

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-96">
            <h2 class="text-2xl font-bold mb-4 text-center">Admin Login</h2>
            <input type="password" id="adminPass" placeholder="Enter Admin Password" class="w-full p-3 border rounded mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="checkLogin()" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 font-bold">Login</button>
            <p id="loginError" class="text-red-500 text-sm mt-2 hidden">ভুল পাসওয়ার্ড!</p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden h-full flex flex-col">
        <!-- Navbar -->
        <nav class="bg-white shadow-md p-4 flex justify-between items-center z-10">
            <h1 class="text-xl font-bold text-blue-600 flex items-center gap-2">
                <i class="fa-solid fa-robot"></i> AI Bot Dashboard
            </h1>
            <div class="flex items-center gap-4">
                <button onclick="logout()" class="text-sm text-red-500 font-semibold hover:underline">Logout</button>
            </div>
        </nav>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-64 bg-gray-800 text-white flex flex-col hidden md:flex flex-shrink-0">
                <div class="p-4 text-gray-400 text-xs font-bold uppercase tracking-wider">Menu</div>
                <nav class="flex-1 space-y-1">
                    <button onclick="showSection('inbox')" class="w-full text-left p-4 hover:bg-gray-700 border-l-4 border-blue-500 bg-gray-700 flex items-center gap-3 transition-colors" id="btn-inbox">
                        <i class="fa-solid fa-inbox"></i> Live Inbox
                    </button>
                    <button onclick="showSection('pages')" class="w-full text-left p-4 hover:bg-gray-700 border-l-4 border-transparent flex items-center gap-3 transition-colors" id="btn-pages">
                        <i class="fa-brands fa-facebook"></i> Pages & Persona
                    </button>
                    <button onclick="showSection('stats')" class="w-full text-left p-4 hover:bg-gray-700 border-l-4 border-transparent flex items-center gap-3 transition-colors" id="btn-stats">
                        <i class="fa-solid fa-chart-line"></i> Statistics
                    </button>
                </nav>
            </aside>

            <!-- Content Area -->
            <main class="flex-1 bg-gray-100 relative overflow-hidden flex flex-col">
                
                <!-- INBOX SECTION -->
                <div id="inbox-section" class="flex h-full w-full">
                    <!-- Inbox: Conversation List (Left) -->
                    <div class="w-1/3 bg-white border-r flex flex-col min-w-[250px]">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                            <h2 class="font-bold text-lg">Inbox</h2>
                            <div class="text-xs text-gray-500 flex items-center gap-1">
                                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Live
                            </div>
                        </div>
                        <div id="conversation-list" class="flex-1 overflow-y-auto">
                            <div class="p-4 text-center text-gray-400">Loading...</div>
                        </div>
                    </div>

                    <!-- Inbox: Chat Window (Right) -->
                    <div class="flex-1 flex flex-col bg-gray-100 relative" id="chat-window">
                        <!-- Chat Header -->
                        <div id="chat-header" class="p-4 bg-white border-b flex justify-between items-center hidden">
                            <div>
                                <h3 class="font-bold text-lg flex items-center gap-2">
                                    <i class="fa-solid fa-user-circle text-gray-400"></i>
                                    <!-- নাম এবং আইডি এখানে দেখাবে -->
                                    <span id="active-user-name">Loading...</span>
                                </h3>
                                <p class="text-xs text-gray-500" id="active-page-id">Page: ...</p>
                            </div>
                            <div class="flex items-center gap-3 bg-gray-50 p-2 rounded-lg border">
                                <span class="text-sm font-medium text-gray-700">AI Reply:</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="ai-toggle" class="sr-only peer" onchange="toggleAI()">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    <span id="ai-status-text" class="ml-3 text-sm font-bold text-green-600">ON</span>
                                </label>
                            </div>
                        </div>

                        <!-- Chat Messages Area -->
                        <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4 hidden scroll-smooth">
                            <div class="flex justify-center items-center h-full text-gray-400 flex-col gap-2">
                                <i class="fa-regular fa-comments text-4xl"></i>
                                <p>Select a conversation to start messaging</p>
                            </div>
                        </div>

                        <!-- Chat Input Area -->
                        <div id="chat-input-area" class="p-4 bg-white border-t hidden">
                            <div class="flex gap-2">
                                <input type="text" id="reply-input" placeholder="Type a manual reply..." class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onkeypress="handleEnter(event)">
                                <button onclick="sendReply()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-bold flex items-center gap-2 transition-transform active:scale-95">
                                    <i class="fa-solid fa-paper-plane"></i> Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OTHER SECTIONS (Stats & Pages) -->
                <div id="stats-section" class="p-6 hidden h-full overflow-y-auto">
                    <!-- Stats Content -->
                    <h2 class="text-2xl font-bold mb-6">Overview</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500">
                            <h3 class="text-gray-500">Total Interactions</h3>
                            <p class="text-3xl font-bold" id="total-logs">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
                            <h3 class="text-gray-500">Active Pages</h3>
                            <p class="text-3xl font-bold" id="total-pages">0</p>
                        </div>
                    </div>
                </div>

                <div id="pages-section" class="p-6 hidden h-full overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Connected Pages & Persona</h2>
                        <button onclick="openAddPageModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> Add/Update Page
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-50 text-gray-600 text-sm uppercase">
                                    <th class="p-4 border-b">Page Name</th>
                                    <th class="p-4 border-b">Page ID</th>
                                    <th class="p-4 border-b w-1/3">AI Persona</th>
                                    <th class="p-4 border-b text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="pages-table-body"></tbody>
                        </table>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Modal for Page Management -->
    <div id="addPageModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-[500px]">
            <h2 class="text-xl font-bold mb-4">Manage Facebook Page</h2>
            <div class="space-y-3">
                <input type="text" id="newPageName" placeholder="Page Name" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="text" id="newPageId" placeholder="Page ID (Required)" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="password" id="newPageToken" placeholder="Access Token" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                <textarea id="newPagePersona" rows="4" placeholder="AI Persona / Instruction..." class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeAddPageModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                <button onclick="savePage()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Save</button>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('adminPass');
        let currentActiveUser = null;
        let currentActivePage = null;
        let pollingInterval = null;

        if (authToken) checkLogin(true);

        async function checkLogin(isAuto = false) {
            const pass = isAuto ? authToken : document.getElementById('adminPass').value;
            try {
                const res = await fetch('/api/stats', { headers: { 'x-admin-pass': pass } });
                if (res.ok) {
                    localStorage.setItem('adminPass', pass);
                    authToken = pass;
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    startPolling(); // Start auto-refresh
                    loadDashboardData();
                } else if(!isAuto) document.getElementById('loginError').classList.remove('hidden');
            } catch (e) { console.error(e); }
        }

        function logout() { 
            localStorage.removeItem('adminPass'); 
            clearInterval(pollingInterval);
            location.reload(); 
        }

        // --- Auto Refresh Logic ---
        function startPolling() {
            if(pollingInterval) clearInterval(pollingInterval);
            // প্রতি ৩ সেকেন্ড পর পর ডাটা চেক করবে
            pollingInterval = setInterval(() => {
                if(!document.getElementById('dashboard').classList.contains('hidden')) {
                    // ইনবক্স লিস্ট আপডেট
                    if(!document.getElementById('inbox-section').classList.contains('hidden')) {
                        loadConversations(true); 
                        // যদি চ্যাট ওপেন থাকে, তবে মেসেজ আপডেট
                        if(currentActiveUser) refreshChat(true);
                    }
                }
            }, 3000);
        }

        function showSection(sectionId) {
            ['inbox', 'stats', 'pages'].forEach(id => {
                document.getElementById(`${id}-section`).classList.add('hidden');
                document.getElementById(`btn-${id}`).classList.remove('bg-gray-700', 'border-blue-500');
                document.getElementById(`btn-${id}`).classList.add('border-transparent');
            });
            document.getElementById(`${sectionId}-section`).classList.remove('hidden');
            document.getElementById(`btn-${sectionId}`).classList.add('bg-gray-700', 'border-blue-500');
            document.getElementById(`btn-${sectionId}`).classList.remove('border-transparent');

            if(sectionId === 'inbox') loadConversations();
            if(sectionId === 'pages') fetchPages();
            if(sectionId === 'stats') fetchStats();
        }

        async function loadDashboardData() { showSection('inbox'); }

        // --- INBOX LOGIC ---
        let lastConvsHash = ""; // To prevent UI flickering

        async function loadConversations(isBackground = false) {
            try {
                const res = await fetch('/api/inbox/conversations', { headers: { 'x-admin-pass': authToken } });
                const users = await res.json();
                
                // Simple hash check to avoid redraw if data hasn't changed
                const currentHash = JSON.stringify(users.map(u => u.lastInteraction));
                if(isBackground && currentHash === lastConvsHash) return;
                lastConvsHash = currentHash;

                const list = document.getElementById('conversation-list');
                
                if(users.length === 0) {
                    list.innerHTML = '<div class="p-4 text-center text-gray-400">No conversations yet.</div>';
                    return;
                }

                // UI Rebuild
                let html = '';
                users.forEach(u => {
                    // নাম এবং আইডি ফরম্যাটিং (লিস্টের জন্য)
                    const displayName = u.userName 
                        ? `<span class="font-bold">${u.userName}</span> <span class="text-xs text-gray-500">(${u.userId})</span>` 
                        : `<span class="font-bold">User: ${u.userId}</span>`;
                        
                    const activeClass = (currentActiveUser === u.userId) ? 'bg-blue-50 border-l-4 border-blue-500' : 'hover:bg-gray-50';
                    
                    html += `
                        <div onclick="openChat('${u.pageId}', '${u.userId}', '${u.userName ? u.userName.replace(/'/g, "\\'") : ''}')" class="p-4 border-b cursor-pointer transition flex items-center gap-3 ${activeClass}">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold flex-shrink-0">
                                ${u.userName ? u.userName.charAt(0).toUpperCase() : '<i class="fa-solid fa-user"></i>'}
                            </div>
                            <div class="flex-1 overflow-hidden">
                                <p class="text-sm text-gray-800 truncate">${displayName}</p>
                                <p class="text-xs text-gray-500 truncate">Page: ${u.pageId}</p>
                                <p class="text-xs text-gray-400 mt-1 truncate flex items-center gap-1">
                                    <i class="fa-regular fa-clock"></i> ${moment(u.lastInteraction).fromNow()}
                                </p>
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html;
            } catch (e) { console.error(e); }
        }

        async function openChat(pageId, userId, userName) {
            currentActivePage = pageId;
            currentActiveUser = userId;
            
            loadConversations(); 

            document.getElementById('chat-header').classList.remove('hidden');
            document.getElementById('messages-container').classList.remove('hidden');
            document.getElementById('chat-input-area').classList.remove('hidden');
            
            // নাম এবং আইডি সেট করা (হেডারের জন্য)
            const nameDisplay = (userName && userName !== 'undefined' && userName !== '') 
                ? `${userName} <span class="text-xs text-gray-400 font-normal ml-2">(${userId})</span>` 
                : `User: ${userId}`;
                
            document.getElementById('active-user-name').innerHTML = nameDisplay;
            document.getElementById('active-page-id').innerText = `Page ID: ${pageId}`;

            try {
                // AI Status Check
                const statusRes = await fetch(`/api/inbox/ai-status?pageId=${pageId}&userId=${userId}`, { headers: { 'x-admin-pass': authToken } });
                const statusData = await statusRes.json();
                const toggle = document.getElementById('ai-toggle');
                
                toggle.checked = !statusData.paused; // If paused=false, Toggle=Checked (ON)
                updateToggleUI(toggle.checked);

                await refreshChat();
                // Scroll to bottom on open
                const container = document.getElementById('messages-container');
                container.scrollTop = container.scrollHeight;
            } catch (e) { console.error(e); }
        }

        let lastMsgCount = 0;
        async function refreshChat(isBackground = false) {
            if(!currentActiveUser) return;
            try {
                const res = await fetch(`/api/inbox/messages?pageId=${currentActivePage}&userId=${currentActiveUser}`, { headers: { 'x-admin-pass': authToken } });
                const messages = await res.json();
                
                if(isBackground && messages.length === lastMsgCount) return;
                lastMsgCount = messages.length;

                const container = document.getElementById('messages-container');
                
                let html = '';
                messages.forEach(msg => {
                    const isUser = msg.sender === 'user';
                    const isAdmin = msg.sender === 'admin';
                    
                    const align = isUser ? 'justify-start' : 'justify-end';
                    const bubbleColor = isUser ? 'bg-white border text-gray-800' : (isAdmin ? 'bg-blue-600 text-white' : 'bg-green-100 text-green-900 border border-green-200');
                    const senderLabel = isUser ? 'Customer' : (isAdmin ? 'You' : 'AI Bot');
                    const labelColor = isUser ? 'text-gray-400' : (isAdmin ? 'text-blue-600' : 'text-green-600');

                    html += `
                        <div class="flex ${align} mb-4">
                            <div class="max-w-[75%] flex flex-col ${isUser ? 'items-start' : 'items-end'}">
                                <span class="text-[10px] font-bold uppercase mb-1 ${labelColor} px-1">${senderLabel}</span>
                                <div class="${bubbleColor} p-3 rounded-2xl shadow-sm text-sm whitespace-pre-wrap leading-relaxed">${msg.text}</div>
                                <span class="text-[10px] text-gray-300 mt-1 px-1">${moment(msg.timestamp).format('h:mm A')}</span>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
                
                if(!isBackground) container.scrollTop = container.scrollHeight;
            } catch (e) { console.error(e); }
        }

        function updateToggleUI(isChecked) {
            const statusText = document.getElementById('ai-status-text');
            if(isChecked) {
                statusText.innerText = "ON";
                statusText.className = "ml-3 text-sm font-bold text-green-600";
            } else {
                statusText.innerText = "PAUSED";
                statusText.className = "ml-3 text-sm font-bold text-red-500";
            }
        }

        async function toggleAI() {
            const isChecked = document.getElementById('ai-toggle').checked;
            updateToggleUI(isChecked);
            
            try {
                // Save state
                const res = await fetch('/api/inbox/toggle-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-pass': authToken },
                    body: JSON.stringify({ 
                        pageId: currentActivePage, 
                        userId: currentActiveUser, 
                        paused: !isChecked // Checked means ON (Not Paused)
                    })
                });

                if(!res.ok) {
                    console.error("Failed to save AI state");
                    // Revert UI if failed
                    document.getElementById('ai-toggle').checked = !isChecked;
                    updateToggleUI(!isChecked);
                    alert("Failed to change AI status!");
                }
            } catch (e) {
                console.error(e);
                // Revert UI if failed
                document.getElementById('ai-toggle').checked = !isChecked;
                updateToggleUI(!isChecked);
            }
        }

        function handleEnter(e) { if(e.key === 'Enter') sendReply(); }

        async function sendReply() {
            const input = document.getElementById('reply-input');
            const text = input.value.trim();
            if(!text || !currentActiveUser) return;

            input.value = ''; // Clear immediately
            
            try {
                const res = await fetch('/api/inbox/reply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-pass': authToken },
                    body: JSON.stringify({
                        pageId: currentActivePage,
                        userId: currentActiveUser,
                        text: text
                    })
                });

                if(res.ok) {
                    refreshChat(); // Immediate refresh
                } else {
                    const err = await res.json();
                    alert("Failed to send: " + (err.error || "Unknown Error"));
                }
            } catch (e) {
                console.error(e);
                alert("Error sending message! Check console.");
            }
        }

        // --- Other Sections (Same as before) ---
        async function fetchStats() {
            const res = await fetch('/api/stats', { headers: { 'x-admin-pass': authToken } });
            const data = await res.json();
            document.getElementById('total-logs').innerText = data.totalLogs;
            document.getElementById('total-pages').innerText = data.totalPages;
        }

        async function fetchPages() {
            const res = await fetch('/api/pages', { headers: { 'x-admin-pass': authToken } });
            const pages = await res.json();
            const tbody = document.getElementById('pages-table-body');
            tbody.innerHTML = '';
            pages.forEach(page => {
                const personaShort = page.System_Prompt ? page.System_Prompt.substring(0, 30) + '...' : '<span class="text-gray-400 italic">Default</span>';
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-4 font-bold">${page.Page_Name || 'Unknown'}</td>
                        <td class="p-4 font-mono text-xs text-blue-600">${page.Page_ID}</td>
                        <td class="p-4 text-xs text-gray-600">${personaShort}</td>
                        <td class="p-4 text-right">
                            <button onclick="editPage('${page.Page_Name}', '${page.Page_ID}', '${page.System_Prompt ? page.System_Prompt.replace(/'/g, "\\'") : ''}')" class="text-blue-600 hover:underline text-xs font-bold">Edit</button>
                        </td>
                    </tr>
                `;
            });
        }

        function openAddPageModal() { document.getElementById('addPageModal').classList.remove('hidden'); }
        function closeAddPageModal() { document.getElementById('addPageModal').classList.add('hidden'); }
        
        function editPage(name, id, persona) {
            document.getElementById('newPageName').value = name;
            document.getElementById('newPageId').value = id;
            document.getElementById('newPageToken').value = ''; 
            document.getElementById('newPagePersona').value = persona;
            document.getElementById('addPageModal').classList.remove('hidden');
        }

        async function savePage() {
            const name = document.getElementById('newPageName').value;
            const id = document.getElementById('newPageId').value;
            const token = document.getElementById('newPageToken').value;
            const persona = document.getElementById('newPagePersona').value;

            if (!id) { alert("Page ID Required"); return; }

            await fetch('/api/pages', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json', 'x-admin-pass': authToken}, 
                body: JSON.stringify({name, id, token, persona}) 
            });
            closeAddPageModal(); 
            fetchPages();
        }
    </script>
</body>
</html>
